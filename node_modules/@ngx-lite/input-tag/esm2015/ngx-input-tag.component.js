import { forwardRef, Component, EventEmitter, HostListener, Input, Output, ViewChild, Inject, ViewEncapsulation, ChangeDetectionStrategy, } from '@angular/core';
import { NG_VALIDATORS, NG_VALUE_ACCESSOR, } from '@angular/forms';
import { NGX_INPUT_TAG_TAG_FORMATTER, } from './ngx-input-tag.di-tokens';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common";
const _c0 = ["inputElement"];
function NgxInputTagComponent_div_1_Template(rf, ctx) { if (rf & 1) {
    const _r5 = i0.ɵɵgetCurrentView();
    i0.ɵɵelementStart(0, "div", 6);
    i0.ɵɵtext(1);
    i0.ɵɵelementStart(2, "button", 7);
    i0.ɵɵlistener("click", function NgxInputTagComponent_div_1_Template_button_click_2_listener($event) { i0.ɵɵrestoreView(_r5); const tag_r3 = ctx.$implicit; const ctx_r4 = i0.ɵɵnextContext(); return ctx_r4.removeTag(tag_r3, $event); });
    i0.ɵɵtext(3, " \u2716 ");
    i0.ɵɵelementEnd();
    i0.ɵɵelementEnd();
} if (rf & 2) {
    const tag_r3 = ctx.$implicit;
    i0.ɵɵadvance(1);
    i0.ɵɵtextInterpolate1(" ", tag_r3, " ");
} }
function NgxInputTagComponent_div_6_button_1_Template(rf, ctx) { if (rf & 1) {
    const _r9 = i0.ɵɵgetCurrentView();
    i0.ɵɵelementStart(0, "button", 10);
    i0.ɵɵlistener("click", function NgxInputTagComponent_div_6_button_1_Template_button_click_0_listener() { i0.ɵɵrestoreView(_r9); const tag_r7 = ctx.$implicit; const ctx_r8 = i0.ɵɵnextContext(2); return ctx_r8.addSuggestedTag(tag_r7); });
    i0.ɵɵtext(1);
    i0.ɵɵelementEnd();
} if (rf & 2) {
    const tag_r7 = ctx.$implicit;
    i0.ɵɵadvance(1);
    i0.ɵɵtextInterpolate(tag_r7);
} }
function NgxInputTagComponent_div_6_Template(rf, ctx) { if (rf & 1) {
    i0.ɵɵelementStart(0, "div", 8);
    i0.ɵɵtemplate(1, NgxInputTagComponent_div_6_button_1_Template, 2, 1, "button", 9);
    i0.ɵɵelementEnd();
} if (rf & 2) {
    const ctx_r2 = i0.ɵɵnextContext();
    i0.ɵɵadvance(1);
    i0.ɵɵproperty("ngForOf", ctx_r2.tagSuggestions);
} }
export var KeyCodes;
(function (KeyCodes) {
    KeyCodes[KeyCodes["Backspace"] = 8] = "Backspace";
    KeyCodes[KeyCodes["Tab"] = 9] = "Tab";
    KeyCodes[KeyCodes["Enter"] = 13] = "Enter";
    KeyCodes[KeyCodes["Escape"] = 27] = "Escape";
    KeyCodes[KeyCodes["LeftArrow"] = 37] = "LeftArrow";
    KeyCodes[KeyCodes["UpArrow"] = 38] = "UpArrow";
    KeyCodes[KeyCodes["RightArrow"] = 39] = "RightArrow";
    KeyCodes[KeyCodes["DownArrow"] = 40] = "DownArrow";
    KeyCodes[KeyCodes["Comma"] = 188] = "Comma";
})(KeyCodes || (KeyCodes = {}));
export class NgxInputTagComponent {
    constructor(tagFormatter) {
        this.tagFormatter = tagFormatter;
        this.tagSuggestions = [];
        this.maxTagLength = 25;
        this.maxNumberOfTags = 1000;
        this.textChange = new EventEmitter();
        this._value = [];
        this.prevTagInput = '';
        this.currentNumberOfTags = 0;
        this.tagError = null;
        this.onChange = (_value) => { };
        this.onTouched = () => { };
    }
    get value() {
        return this._value;
    }
    set value(val) {
        this._value = val;
        this.onChange(val);
        this.onTouched();
    }
    registerOnChange(fn) {
        this.onChange = fn;
    }
    registerOnTouched(fn) {
        this.onTouched = fn;
    }
    writeValue(value) {
        if (value) {
            this.value = value.map((v) => this.tagFormatter(v));
            this.setCurrentNumberOfTags();
        }
    }
    validate() {
        return this.tagError;
    }
    handleClick(event) {
        if (this.inputElement &&
            !this.inputElement.nativeElement.contains(event.target) &&
            this.inputElement.nativeElement.value) {
            this.addTag(this.inputElement.nativeElement.value);
        }
    }
    addTag(tag) {
        const formattedTag = this.tagFormatter(tag);
        const tagIsEmpty = formattedTag.length === 0;
        const invalidTagLength = !formattedTag.length ||
            (this.maxTagLength && formattedTag.length > this.maxTagLength);
        const duplicateTag = this.value.indexOf(formattedTag) > -1;
        const exceedsMaxNumberOfTags = this.currentNumberOfTags > this.maxNumberOfTags;
        if (!tagIsEmpty && invalidTagLength) {
            this.tagError = {
                message: `Tag length cannot exceed ${this.maxTagLength} characters`,
            };
        }
        if (duplicateTag) {
            this.tagError = { message: 'Cannot add duplicate tag' };
        }
        if (exceedsMaxNumberOfTags) {
            const plural = this.maxNumberOfTags === 1 ? '' : 's';
            this.tagError = {
                message: `Cannot exceed ${this.maxNumberOfTags} tag${plural}`,
            };
        }
        if (!tagIsEmpty &&
            !invalidTagLength &&
            !duplicateTag &&
            !exceedsMaxNumberOfTags &&
            this.inputElement) {
            this.tagError = null;
            this.value.push(formattedTag);
            this.setCurrentNumberOfTags();
            this.inputElement.nativeElement.value = '';
        }
        this.value = this.value;
        this.focus();
    }
    addTagEvent(event) {
        const input = event.target;
        this.tagError = null;
        this.value = this.value;
        this.textChange.emit(input.value);
        if (event.keyCode === KeyCodes.Backspace &&
            this.prevTagInput.length === 0) {
            this._value.pop();
            this.setCurrentNumberOfTags();
        }
        else if (event.keyCode === KeyCodes.Enter ||
            event.keyCode === KeyCodes.Comma ||
            event.keyCode === KeyCodes.Tab) {
            this.addTag(input.value);
        }
        this.prevTagInput = input.value;
    }
    preventDefaultTabBehavior(event) {
        if (event.keyCode === KeyCodes.Tab && this.prevTagInput.length > 0) {
            event.preventDefault();
        }
    }
    addTagClick(event, value) {
        event.preventDefault();
        if (value.length > 0) {
            this.addTag(value);
        }
    }
    addSuggestedTag(tag) {
        this.addTag(tag);
    }
    removeTag(tag, event) {
        if (event.keyCode !== KeyCodes.Enter) {
            this.value = this._value.filter((t) => t !== tag);
            this.setCurrentNumberOfTags();
        }
    }
    focus() {
        var _a;
        (_a = this.inputElement) === null || _a === void 0 ? void 0 : _a.nativeElement.focus();
    }
    setCurrentNumberOfTags() {
        this.currentNumberOfTags = this.value.length
            ? this.value.toString().split(',').length
            : 0;
    }
}
NgxInputTagComponent.ɵfac = function NgxInputTagComponent_Factory(t) { return new (t || NgxInputTagComponent)(i0.ɵɵdirectiveInject(NGX_INPUT_TAG_TAG_FORMATTER)); };
NgxInputTagComponent.ɵcmp = i0.ɵɵdefineComponent({ type: NgxInputTagComponent, selectors: [["ngx-input-tag"]], viewQuery: function NgxInputTagComponent_Query(rf, ctx) { if (rf & 1) {
        i0.ɵɵviewQuery(_c0, true);
    } if (rf & 2) {
        let _t;
        i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.inputElement = _t.first);
    } }, hostBindings: function NgxInputTagComponent_HostBindings(rf, ctx) { if (rf & 1) {
        i0.ɵɵlistener("click", function NgxInputTagComponent_click_HostBindingHandler($event) { return ctx.handleClick($event); }, false, i0.ɵɵresolveDocument);
    } }, inputs: { tagSuggestions: "tagSuggestions", maxTagLength: "maxTagLength", maxNumberOfTags: "maxNumberOfTags" }, outputs: { textChange: "textChange" }, features: [i0.ɵɵProvidersFeature([
            {
                provide: NG_VALUE_ACCESSOR,
                useExisting: forwardRef(() => NgxInputTagComponent),
                multi: true,
            },
            {
                provide: NG_VALIDATORS,
                useExisting: forwardRef(() => NgxInputTagComponent),
                multi: true,
            },
        ])], decls: 7, vars: 4, consts: [[1, "ngx-input-tag", 3, "click"], ["class", "ngx-input-tag__tag", 4, "ngFor", "ngForOf"], ["type", "text", "aria-label", "Tags", 1, "ngx-input-tag__input", 3, "keyup", "keydown"], ["inputElement", ""], ["type", "button", "aria-label", "Add Tag", "title", "Add Tag", 1, "ngx-input-tag__btn", 3, "click"], ["class", "ngx-input-tag-suggestions", 4, "ngIf"], [1, "ngx-input-tag__tag"], ["type", "button", 3, "click"], [1, "ngx-input-tag-suggestions"], ["type", "button", "class", "ngx-input-tag-suggestions__tag", 3, "click", 4, "ngFor", "ngForOf"], ["type", "button", 1, "ngx-input-tag-suggestions__tag", 3, "click"]], template: function NgxInputTagComponent_Template(rf, ctx) { if (rf & 1) {
        const _r10 = i0.ɵɵgetCurrentView();
        i0.ɵɵelementStart(0, "div", 0);
        i0.ɵɵlistener("click", function NgxInputTagComponent_Template_div_click_0_listener() { return ctx.focus(); });
        i0.ɵɵtemplate(1, NgxInputTagComponent_div_1_Template, 4, 1, "div", 1);
        i0.ɵɵelementStart(2, "input", 2, 3);
        i0.ɵɵlistener("keyup", function NgxInputTagComponent_Template_input_keyup_2_listener($event) { return ctx.addTagEvent($event); })("keydown", function NgxInputTagComponent_Template_input_keydown_2_listener($event) { return ctx.preventDefaultTabBehavior($event); });
        i0.ɵɵelementEnd();
        i0.ɵɵelementStart(4, "button", 4);
        i0.ɵɵlistener("click", function NgxInputTagComponent_Template_button_click_4_listener($event) { i0.ɵɵrestoreView(_r10); const _r1 = i0.ɵɵreference(3); return ctx.addTagClick($event, _r1.value); });
        i0.ɵɵtext(5, " + ");
        i0.ɵɵelementEnd();
        i0.ɵɵelementEnd();
        i0.ɵɵtemplate(6, NgxInputTagComponent_div_6_Template, 2, 1, "div", 5);
    } if (rf & 2) {
        const _r1 = i0.ɵɵreference(3);
        i0.ɵɵadvance(1);
        i0.ɵɵproperty("ngForOf", ctx.value);
        i0.ɵɵadvance(1);
        i0.ɵɵstyleProp("width", _r1.value.length * 10 + 10 + "px");
        i0.ɵɵadvance(4);
        i0.ɵɵproperty("ngIf", _r1.value.length && ctx.tagSuggestions && ctx.tagSuggestions.length);
    } }, directives: [i1.NgForOf, i1.NgIf], styles: ["*,:after,:before{box-sizing:border-box}ngx-input-tag{--color-add-button:#ccc;--color-add-button-background:#fff;--color-background:#fff;--color-border:#dbdbdb;--color-tag-close:#ccc;--color-tag-suggestion-hover:#f2f2f2;display:inline-block;margin-bottom:12px;width:100%}.ngx-input-tag{background-color:#fff;background-color:var(--color-background);border:1px solid #dbdbdb;border:1px solid var(--color-border);font-size:16px;margin-bottom:0;padding:5px 80px 4.5px 4px;position:relative}.ngx-input-tag:focus{outline:initial}.ngx-input-tag__input{border:0;font-size:16px;margin-bottom:0;margin-left:4px;max-width:calc(100% + 70px);min-height:29px;min-width:4px;outline:none;padding:4px 0;width:8px}.ngx-input-tag__tag{border:1px solid #dbdbdb;border:1px solid var(--color-border);border-radius:2px;display:inline-block;height:29px;line-height:18px;margin-right:4px;padding:4px}.ngx-input-tag__tag button{background:transparent;border:0;color:var(--color-tag-close);cursor:pointer}.ngx-input-tag__btn{background-color:#fff;background-color:var(--color-add-button-background);color:#ccc;color:var(--color-add-button);cursor:pointer;font-size:30px;height:41px;position:absolute;right:-1px;top:-1px;width:50px}.ngx-input-tag-suggestions,.ngx-input-tag__btn{border:1px solid #dbdbdb;border:1px solid var(--color-border)}.ngx-input-tag-suggestions{background-color:#fff;background-color:var(--color-background)}.ngx-input-tag-suggestions__tag{background:transparent;border:0;cursor:pointer;display:block;padding:10px 14px;text-align:left;width:100%}.ngx-input-tag-suggestions__tag:hover{background:#f2f2f2;background:var(--color-tag-suggestion-hover)}"], encapsulation: 2, changeDetection: 0 });
/*@__PURE__*/ (function () { i0.ɵsetClassMetadata(NgxInputTagComponent, [{
        type: Component,
        args: [{
                selector: 'ngx-input-tag',
                templateUrl: './ngx-input-tag.component.html',
                styleUrls: ['./ngx-input-tag.component.scss'],
                changeDetection: ChangeDetectionStrategy.OnPush,
                providers: [
                    {
                        provide: NG_VALUE_ACCESSOR,
                        useExisting: forwardRef(() => NgxInputTagComponent),
                        multi: true,
                    },
                    {
                        provide: NG_VALIDATORS,
                        useExisting: forwardRef(() => NgxInputTagComponent),
                        multi: true,
                    },
                ],
                encapsulation: ViewEncapsulation.None,
            }]
    }], function () { return [{ type: undefined, decorators: [{
                type: Inject,
                args: [NGX_INPUT_TAG_TAG_FORMATTER]
            }] }]; }, { inputElement: [{
            type: ViewChild,
            args: ['inputElement', { static: false }]
        }], tagSuggestions: [{
            type: Input
        }], maxTagLength: [{
            type: Input
        }], maxNumberOfTags: [{
            type: Input
        }], textChange: [{
            type: Output
        }], handleClick: [{
            type: HostListener,
            args: ['document:click', ['$event']]
        }] }); })();
export function formatter(tag) {
    return tag
        .trim()
        .replace(/(\s|-)+/g, '-')
        .replace(/\,/g, '')
        .toLowerCase();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LWlucHV0LXRhZy5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4vcHJvamVjdHMvbmd4LWlucHV0LXRhZy9zcmMvIiwic291cmNlcyI6WyJuZ3gtaW5wdXQtdGFnLmNvbXBvbmVudC50cyIsIm5neC1pbnB1dC10YWcuY29tcG9uZW50Lmh0bWwiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNMLFVBQVUsRUFDVixTQUFTLEVBRVQsWUFBWSxFQUNaLFlBQVksRUFDWixLQUFLLEVBQ0wsTUFBTSxFQUNOLFNBQVMsRUFDVCxNQUFNLEVBQ04saUJBQWlCLEVBQ2pCLHVCQUF1QixHQUN4QixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBRUwsYUFBYSxFQUNiLGlCQUFpQixHQUNsQixNQUFNLGdCQUFnQixDQUFDO0FBQ3hCLE9BQU8sRUFDTCwyQkFBMkIsR0FFNUIsTUFBTSwyQkFBMkIsQ0FBQzs7Ozs7O0lDcEJqQyw4QkFDRTtJQUFBLFlBQ0E7SUFBQSxpQ0FDRTtJQURvQix5T0FBZ0M7SUFDcEQsd0JBQ0Y7SUFBQSxpQkFBUztJQUNYLGlCQUFNOzs7SUFKSixlQUNBO0lBREEsdUNBQ0E7Ozs7SUFZRixrQ0FBK0g7SUFBekcsMk9BQThCO0lBQTJFLFlBQU87SUFBQSxpQkFBUzs7O0lBQWhCLGVBQU87SUFBUCw0QkFBTzs7O0lBRHhJLDhCQUNFO0lBQUEsaUZBQStJO0lBQ2pKLGlCQUFNOzs7SUFEaUUsZUFBaUI7SUFBakIsK0NBQWlCOztBRFF4RixNQUFNLENBQU4sSUFBWSxRQVVYO0FBVkQsV0FBWSxRQUFRO0lBQ2xCLGlEQUFhLENBQUE7SUFDYixxQ0FBTyxDQUFBO0lBQ1AsMENBQVUsQ0FBQTtJQUNWLDRDQUFXLENBQUE7SUFDWCxrREFBYyxDQUFBO0lBQ2QsOENBQVksQ0FBQTtJQUNaLG9EQUFlLENBQUE7SUFDZixrREFBYyxDQUFBO0lBQ2QsMkNBQVcsQ0FBQTtBQUNiLENBQUMsRUFWVyxRQUFRLEtBQVIsUUFBUSxRQVVuQjtBQXFCRCxNQUFNLE9BQU8sb0JBQW9CO0lBc0IvQixZQUMrQyxZQUEwQjtRQUExQixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQVhoRSxtQkFBYyxHQUFhLEVBQUUsQ0FBQztRQUM5QixpQkFBWSxHQUFHLEVBQUUsQ0FBQztRQUNsQixvQkFBZSxHQUFHLElBQUksQ0FBQztRQUNiLGVBQVUsR0FBRyxJQUFJLFlBQVksRUFBVSxDQUFDO1FBRW5ELFdBQU0sR0FBYSxFQUFFLENBQUM7UUFDdEIsaUJBQVksR0FBRyxFQUFFLENBQUM7UUFDbEIsd0JBQW1CLEdBQUcsQ0FBQyxDQUFDO1FBQ3hCLGFBQVEsR0FBK0IsSUFBSSxDQUFDO1FBTXBELGFBQVEsR0FBRyxDQUFDLE1BQWdCLEVBQUUsRUFBRSxHQUFFLENBQUMsQ0FBQztRQUVwQyxjQUFTLEdBQUcsR0FBRyxFQUFFLEdBQUUsQ0FBQyxDQUFDO0lBSmxCLENBQUM7SUF2QkosSUFBSSxLQUFLO1FBQ1AsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDO0lBQ3JCLENBQUM7SUFFRCxJQUFJLEtBQUssQ0FBQyxHQUFHO1FBQ1gsSUFBSSxDQUFDLE1BQU0sR0FBRyxHQUFHLENBQUM7UUFDbEIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNuQixJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7SUFDbkIsQ0FBQztJQXFCRCxnQkFBZ0IsQ0FBQyxFQUE2QjtRQUM1QyxJQUFJLENBQUMsUUFBUSxHQUFHLEVBQUUsQ0FBQztJQUNyQixDQUFDO0lBRUQsaUJBQWlCLENBQUMsRUFBYztRQUM5QixJQUFJLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQztJQUN0QixDQUFDO0lBRUQsVUFBVSxDQUFDLEtBQWU7UUFDeEIsSUFBSSxLQUFLLEVBQUU7WUFDVCxJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNwRCxJQUFJLENBQUMsc0JBQXNCLEVBQUUsQ0FBQztTQUMvQjtJQUNILENBQUM7SUFFRCxRQUFRO1FBQ04sT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDO0lBQ3ZCLENBQUM7SUFHRCxXQUFXLENBQUMsS0FBaUI7UUFDM0IsSUFDRSxJQUFJLENBQUMsWUFBWTtZQUNqQixDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDO1lBQ3ZELElBQUksQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUFDLEtBQUssRUFDckM7WUFDQSxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ3BEO0lBQ0gsQ0FBQztJQUVELE1BQU0sQ0FBQyxHQUFXO1FBQ2hCLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDNUMsTUFBTSxVQUFVLEdBQUcsWUFBWSxDQUFDLE1BQU0sS0FBSyxDQUFDLENBQUM7UUFDN0MsTUFBTSxnQkFBZ0IsR0FDcEIsQ0FBQyxZQUFZLENBQUMsTUFBTTtZQUNwQixDQUFDLElBQUksQ0FBQyxZQUFZLElBQUksWUFBWSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDakUsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDM0QsTUFBTSxzQkFBc0IsR0FDMUIsSUFBSSxDQUFDLG1CQUFtQixHQUFHLElBQUksQ0FBQyxlQUFlLENBQUM7UUFFbEQsSUFBSSxDQUFDLFVBQVUsSUFBSSxnQkFBZ0IsRUFBRTtZQUNuQyxJQUFJLENBQUMsUUFBUSxHQUFHO2dCQUNkLE9BQU8sRUFBRSw0QkFBNEIsSUFBSSxDQUFDLFlBQVksYUFBYTthQUNwRSxDQUFDO1NBQ0g7UUFFRCxJQUFJLFlBQVksRUFBRTtZQUNoQixJQUFJLENBQUMsUUFBUSxHQUFHLEVBQUUsT0FBTyxFQUFFLDBCQUEwQixFQUFFLENBQUM7U0FDekQ7UUFFRCxJQUFJLHNCQUFzQixFQUFFO1lBQzFCLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxlQUFlLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQztZQUNyRCxJQUFJLENBQUMsUUFBUSxHQUFHO2dCQUNkLE9BQU8sRUFBRSxpQkFBaUIsSUFBSSxDQUFDLGVBQWUsT0FBTyxNQUFNLEVBQUU7YUFDOUQsQ0FBQztTQUNIO1FBRUQsSUFDRSxDQUFDLFVBQVU7WUFDWCxDQUFDLGdCQUFnQjtZQUNqQixDQUFDLFlBQVk7WUFDYixDQUFDLHNCQUFzQjtZQUN2QixJQUFJLENBQUMsWUFBWSxFQUNqQjtZQUNBLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO1lBQ3JCLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO1lBQzlCLElBQUksQ0FBQyxzQkFBc0IsRUFBRSxDQUFDO1lBQzlCLElBQUksQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUFDLEtBQUssR0FBRyxFQUFFLENBQUM7U0FDNUM7UUFFRCxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7UUFDeEIsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ2YsQ0FBQztJQUVELFdBQVcsQ0FBQyxLQUFvQjtRQUM5QixNQUFNLEtBQUssR0FBRyxLQUFLLENBQUMsTUFBMEIsQ0FBQztRQUUvQyxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztRQUNyQixJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7UUFFeEIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ2xDLElBQ0UsS0FBSyxDQUFDLE9BQU8sS0FBSyxRQUFRLENBQUMsU0FBUztZQUNwQyxJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQzlCO1lBQ0EsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUNsQixJQUFJLENBQUMsc0JBQXNCLEVBQUUsQ0FBQztTQUMvQjthQUFNLElBQ0wsS0FBSyxDQUFDLE9BQU8sS0FBSyxRQUFRLENBQUMsS0FBSztZQUNoQyxLQUFLLENBQUMsT0FBTyxLQUFLLFFBQVEsQ0FBQyxLQUFLO1lBQ2hDLEtBQUssQ0FBQyxPQUFPLEtBQUssUUFBUSxDQUFDLEdBQUcsRUFDOUI7WUFDQSxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUMxQjtRQUVELElBQUksQ0FBQyxZQUFZLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQztJQUNsQyxDQUFDO0lBRUQseUJBQXlCLENBQUMsS0FBb0I7UUFDNUMsSUFBSSxLQUFLLENBQUMsT0FBTyxLQUFLLFFBQVEsQ0FBQyxHQUFHLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQ2xFLEtBQUssQ0FBQyxjQUFjLEVBQUUsQ0FBQztTQUN4QjtJQUNILENBQUM7SUFFRCxXQUFXLENBQUMsS0FBaUIsRUFBRSxLQUFhO1FBQzFDLEtBQUssQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUN2QixJQUFJLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQ3BCLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDcEI7SUFDSCxDQUFDO0lBRUQsZUFBZSxDQUFDLEdBQVc7UUFDekIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNuQixDQUFDO0lBRUQsU0FBUyxDQUFDLEdBQVcsRUFBRSxLQUFVO1FBQy9CLElBQUksS0FBSyxDQUFDLE9BQU8sS0FBSyxRQUFRLENBQUMsS0FBSyxFQUFFO1lBQ3BDLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQztZQUNsRCxJQUFJLENBQUMsc0JBQXNCLEVBQUUsQ0FBQztTQUMvQjtJQUNILENBQUM7SUFFRCxLQUFLOztRQUNILE1BQUEsSUFBSSxDQUFDLFlBQVksMENBQUUsYUFBYSxDQUFDLEtBQUssR0FBRztJQUMzQyxDQUFDO0lBRUQsc0JBQXNCO1FBQ3BCLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU07WUFDMUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU07WUFDekMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNSLENBQUM7O3dGQWhLVSxvQkFBb0IsdUJBdUJyQiwyQkFBMkI7eURBdkIxQixvQkFBb0I7Ozs7Ozt1R0FBcEIsdUJBQW1CO2lNQWRuQjtZQUNUO2dCQUNFLE9BQU8sRUFBRSxpQkFBaUI7Z0JBQzFCLFdBQVcsRUFBRSxVQUFVLENBQUMsR0FBRyxFQUFFLENBQUMsb0JBQW9CLENBQUM7Z0JBQ25ELEtBQUssRUFBRSxJQUFJO2FBQ1o7WUFDRDtnQkFDRSxPQUFPLEVBQUUsYUFBYTtnQkFDdEIsV0FBVyxFQUFFLFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxvQkFBb0IsQ0FBQztnQkFDbkQsS0FBSyxFQUFFLElBQUk7YUFDWjtTQUNGOztRQ25ESCw4QkFDRTtRQURHLDhGQUFTLFdBQU8sSUFBQztRQUNwQixxRUFLTTtRQUNOLG1DQUVBO1FBRjhHLHNHQUFTLHVCQUFtQixJQUFDLDZGQUFZLHFDQUFpQyxJQUE3QztRQUEzSSxpQkFFQTtRQUFBLGlDQUNFO1FBRHlELDhKQUFTLGtDQUF1QyxJQUFDO1FBQzFHLG1CQUNGO1FBQUEsaUJBQVM7UUFDWCxpQkFBTTtRQUVOLHFFQUVNOzs7UUFmaUIsZUFBUTtRQUFSLG1DQUFRO1FBTXNCLGVBQTBEO1FBQTFELDBEQUEwRDtRQU96RyxlQUEwRTtRQUExRSwwRkFBMEU7O2tERHdDbkUsb0JBQW9CO2NBbkJoQyxTQUFTO2VBQUM7Z0JBQ1QsUUFBUSxFQUFFLGVBQWU7Z0JBQ3pCLFdBQVcsRUFBRSxnQ0FBZ0M7Z0JBQzdDLFNBQVMsRUFBRSxDQUFDLGdDQUFnQyxDQUFDO2dCQUM3QyxlQUFlLEVBQUUsdUJBQXVCLENBQUMsTUFBTTtnQkFDL0MsU0FBUyxFQUFFO29CQUNUO3dCQUNFLE9BQU8sRUFBRSxpQkFBaUI7d0JBQzFCLFdBQVcsRUFBRSxVQUFVLENBQUMsR0FBRyxFQUFFLHFCQUFxQixDQUFDO3dCQUNuRCxLQUFLLEVBQUUsSUFBSTtxQkFDWjtvQkFDRDt3QkFDRSxPQUFPLEVBQUUsYUFBYTt3QkFDdEIsV0FBVyxFQUFFLFVBQVUsQ0FBQyxHQUFHLEVBQUUscUJBQXFCLENBQUM7d0JBQ25ELEtBQUssRUFBRSxJQUFJO3FCQUNaO2lCQUNGO2dCQUNELGFBQWEsRUFBRSxpQkFBaUIsQ0FBQyxJQUFJO2FBQ3RDOztzQkF3QkksTUFBTTt1QkFBQywyQkFBMkI7d0JBWlMsWUFBWTtrQkFBekQsU0FBUzttQkFBQyxjQUFjLEVBQUUsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFO1lBQ25DLGNBQWM7a0JBQXRCLEtBQUs7WUFDRyxZQUFZO2tCQUFwQixLQUFLO1lBQ0csZUFBZTtrQkFBdkIsS0FBSztZQUNhLFVBQVU7a0JBQTVCLE1BQU07WUFtQ1AsV0FBVztrQkFEVixZQUFZO21CQUFDLGdCQUFnQixFQUFFLENBQUMsUUFBUSxDQUFDOztBQWtINUMsTUFBTSxVQUFVLFNBQVMsQ0FBQyxHQUFXO0lBQ25DLE9BQU8sR0FBRztTQUNQLElBQUksRUFBRTtTQUNOLE9BQU8sQ0FBQyxVQUFVLEVBQUUsR0FBRyxDQUFDO1NBQ3hCLE9BQU8sQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDO1NBQ2xCLFdBQVcsRUFBRSxDQUFDO0FBQ25CLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBmb3J3YXJkUmVmLFxuICBDb21wb25lbnQsXG4gIEVsZW1lbnRSZWYsXG4gIEV2ZW50RW1pdHRlcixcbiAgSG9zdExpc3RlbmVyLFxuICBJbnB1dCxcbiAgT3V0cHV0LFxuICBWaWV3Q2hpbGQsXG4gIEluamVjdCxcbiAgVmlld0VuY2Fwc3VsYXRpb24sXG4gIENoYW5nZURldGVjdGlvblN0cmF0ZWd5LFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gIENvbnRyb2xWYWx1ZUFjY2Vzc29yLFxuICBOR19WQUxJREFUT1JTLFxuICBOR19WQUxVRV9BQ0NFU1NPUixcbn0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHtcbiAgTkdYX0lOUFVUX1RBR19UQUdfRk9STUFUVEVSLFxuICBUYWdGb3JtYXR0ZXIsXG59IGZyb20gJy4vbmd4LWlucHV0LXRhZy5kaS10b2tlbnMnO1xuXG5leHBvcnQgZW51bSBLZXlDb2RlcyB7XG4gIEJhY2tzcGFjZSA9IDgsXG4gIFRhYiA9IDksXG4gIEVudGVyID0gMTMsXG4gIEVzY2FwZSA9IDI3LFxuICBMZWZ0QXJyb3cgPSAzNyxcbiAgVXBBcnJvdyA9IDM4LFxuICBSaWdodEFycm93ID0gMzksXG4gIERvd25BcnJvdyA9IDQwLFxuICBDb21tYSA9IDE4OCxcbn1cblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnbmd4LWlucHV0LXRhZycsXG4gIHRlbXBsYXRlVXJsOiAnLi9uZ3gtaW5wdXQtdGFnLmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmxzOiBbJy4vbmd4LWlucHV0LXRhZy5jb21wb25lbnQuc2NzcyddLFxuICBjaGFuZ2VEZXRlY3Rpb246IENoYW5nZURldGVjdGlvblN0cmF0ZWd5Lk9uUHVzaCxcbiAgcHJvdmlkZXJzOiBbXG4gICAge1xuICAgICAgcHJvdmlkZTogTkdfVkFMVUVfQUNDRVNTT1IsXG4gICAgICB1c2VFeGlzdGluZzogZm9yd2FyZFJlZigoKSA9PiBOZ3hJbnB1dFRhZ0NvbXBvbmVudCksXG4gICAgICBtdWx0aTogdHJ1ZSxcbiAgICB9LFxuICAgIHtcbiAgICAgIHByb3ZpZGU6IE5HX1ZBTElEQVRPUlMsXG4gICAgICB1c2VFeGlzdGluZzogZm9yd2FyZFJlZigoKSA9PiBOZ3hJbnB1dFRhZ0NvbXBvbmVudCksXG4gICAgICBtdWx0aTogdHJ1ZSxcbiAgICB9LFxuICBdLFxuICBlbmNhcHN1bGF0aW9uOiBWaWV3RW5jYXBzdWxhdGlvbi5Ob25lLFxufSlcbmV4cG9ydCBjbGFzcyBOZ3hJbnB1dFRhZ0NvbXBvbmVudCBpbXBsZW1lbnRzIENvbnRyb2xWYWx1ZUFjY2Vzc29yIHtcbiAgZ2V0IHZhbHVlKCkge1xuICAgIHJldHVybiB0aGlzLl92YWx1ZTtcbiAgfVxuXG4gIHNldCB2YWx1ZSh2YWwpIHtcbiAgICB0aGlzLl92YWx1ZSA9IHZhbDtcbiAgICB0aGlzLm9uQ2hhbmdlKHZhbCk7XG4gICAgdGhpcy5vblRvdWNoZWQoKTtcbiAgfVxuXG4gIEBWaWV3Q2hpbGQoJ2lucHV0RWxlbWVudCcsIHsgc3RhdGljOiBmYWxzZSB9KSBpbnB1dEVsZW1lbnQ/OiBFbGVtZW50UmVmO1xuICBASW5wdXQoKSB0YWdTdWdnZXN0aW9uczogc3RyaW5nW10gPSBbXTtcbiAgQElucHV0KCkgbWF4VGFnTGVuZ3RoID0gMjU7XG4gIEBJbnB1dCgpIG1heE51bWJlck9mVGFncyA9IDEwMDA7XG4gIEBPdXRwdXQoKSByZWFkb25seSB0ZXh0Q2hhbmdlID0gbmV3IEV2ZW50RW1pdHRlcjxzdHJpbmc+KCk7XG5cbiAgcHJpdmF0ZSBfdmFsdWU6IHN0cmluZ1tdID0gW107XG4gIHByaXZhdGUgcHJldlRhZ0lucHV0ID0gJyc7XG4gIHByaXZhdGUgY3VycmVudE51bWJlck9mVGFncyA9IDA7XG4gIHByaXZhdGUgdGFnRXJyb3I6IHsgbWVzc2FnZTogc3RyaW5nIH0gfCBudWxsID0gbnVsbDtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBASW5qZWN0KE5HWF9JTlBVVF9UQUdfVEFHX0ZPUk1BVFRFUikgcHJpdmF0ZSB0YWdGb3JtYXR0ZXI6IFRhZ0Zvcm1hdHRlclxuICApIHt9XG5cbiAgb25DaGFuZ2UgPSAoX3ZhbHVlOiBzdHJpbmdbXSkgPT4ge307XG5cbiAgb25Ub3VjaGVkID0gKCkgPT4ge307XG5cbiAgcmVnaXN0ZXJPbkNoYW5nZShmbjogKHZhbHVlOiBzdHJpbmdbXSkgPT4gdm9pZCkge1xuICAgIHRoaXMub25DaGFuZ2UgPSBmbjtcbiAgfVxuXG4gIHJlZ2lzdGVyT25Ub3VjaGVkKGZuOiAoKSA9PiB2b2lkKSB7XG4gICAgdGhpcy5vblRvdWNoZWQgPSBmbjtcbiAgfVxuXG4gIHdyaXRlVmFsdWUodmFsdWU6IHN0cmluZ1tdKSB7XG4gICAgaWYgKHZhbHVlKSB7XG4gICAgICB0aGlzLnZhbHVlID0gdmFsdWUubWFwKCh2KSA9PiB0aGlzLnRhZ0Zvcm1hdHRlcih2KSk7XG4gICAgICB0aGlzLnNldEN1cnJlbnROdW1iZXJPZlRhZ3MoKTtcbiAgICB9XG4gIH1cblxuICB2YWxpZGF0ZSgpIHtcbiAgICByZXR1cm4gdGhpcy50YWdFcnJvcjtcbiAgfVxuXG4gIEBIb3N0TGlzdGVuZXIoJ2RvY3VtZW50OmNsaWNrJywgWyckZXZlbnQnXSlcbiAgaGFuZGxlQ2xpY2soZXZlbnQ6IE1vdXNlRXZlbnQpIHtcbiAgICBpZiAoXG4gICAgICB0aGlzLmlucHV0RWxlbWVudCAmJlxuICAgICAgIXRoaXMuaW5wdXRFbGVtZW50Lm5hdGl2ZUVsZW1lbnQuY29udGFpbnMoZXZlbnQudGFyZ2V0KSAmJlxuICAgICAgdGhpcy5pbnB1dEVsZW1lbnQubmF0aXZlRWxlbWVudC52YWx1ZVxuICAgICkge1xuICAgICAgdGhpcy5hZGRUYWcodGhpcy5pbnB1dEVsZW1lbnQubmF0aXZlRWxlbWVudC52YWx1ZSk7XG4gICAgfVxuICB9XG5cbiAgYWRkVGFnKHRhZzogc3RyaW5nKSB7XG4gICAgY29uc3QgZm9ybWF0dGVkVGFnID0gdGhpcy50YWdGb3JtYXR0ZXIodGFnKTtcbiAgICBjb25zdCB0YWdJc0VtcHR5ID0gZm9ybWF0dGVkVGFnLmxlbmd0aCA9PT0gMDtcbiAgICBjb25zdCBpbnZhbGlkVGFnTGVuZ3RoID1cbiAgICAgICFmb3JtYXR0ZWRUYWcubGVuZ3RoIHx8XG4gICAgICAodGhpcy5tYXhUYWdMZW5ndGggJiYgZm9ybWF0dGVkVGFnLmxlbmd0aCA+IHRoaXMubWF4VGFnTGVuZ3RoKTtcbiAgICBjb25zdCBkdXBsaWNhdGVUYWcgPSB0aGlzLnZhbHVlLmluZGV4T2YoZm9ybWF0dGVkVGFnKSA+IC0xO1xuICAgIGNvbnN0IGV4Y2VlZHNNYXhOdW1iZXJPZlRhZ3MgPVxuICAgICAgdGhpcy5jdXJyZW50TnVtYmVyT2ZUYWdzID4gdGhpcy5tYXhOdW1iZXJPZlRhZ3M7XG5cbiAgICBpZiAoIXRhZ0lzRW1wdHkgJiYgaW52YWxpZFRhZ0xlbmd0aCkge1xuICAgICAgdGhpcy50YWdFcnJvciA9IHtcbiAgICAgICAgbWVzc2FnZTogYFRhZyBsZW5ndGggY2Fubm90IGV4Y2VlZCAke3RoaXMubWF4VGFnTGVuZ3RofSBjaGFyYWN0ZXJzYCxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgaWYgKGR1cGxpY2F0ZVRhZykge1xuICAgICAgdGhpcy50YWdFcnJvciA9IHsgbWVzc2FnZTogJ0Nhbm5vdCBhZGQgZHVwbGljYXRlIHRhZycgfTtcbiAgICB9XG5cbiAgICBpZiAoZXhjZWVkc01heE51bWJlck9mVGFncykge1xuICAgICAgY29uc3QgcGx1cmFsID0gdGhpcy5tYXhOdW1iZXJPZlRhZ3MgPT09IDEgPyAnJyA6ICdzJztcbiAgICAgIHRoaXMudGFnRXJyb3IgPSB7XG4gICAgICAgIG1lc3NhZ2U6IGBDYW5ub3QgZXhjZWVkICR7dGhpcy5tYXhOdW1iZXJPZlRhZ3N9IHRhZyR7cGx1cmFsfWAsXG4gICAgICB9O1xuICAgIH1cblxuICAgIGlmIChcbiAgICAgICF0YWdJc0VtcHR5ICYmXG4gICAgICAhaW52YWxpZFRhZ0xlbmd0aCAmJlxuICAgICAgIWR1cGxpY2F0ZVRhZyAmJlxuICAgICAgIWV4Y2VlZHNNYXhOdW1iZXJPZlRhZ3MgJiZcbiAgICAgIHRoaXMuaW5wdXRFbGVtZW50XG4gICAgKSB7XG4gICAgICB0aGlzLnRhZ0Vycm9yID0gbnVsbDtcbiAgICAgIHRoaXMudmFsdWUucHVzaChmb3JtYXR0ZWRUYWcpO1xuICAgICAgdGhpcy5zZXRDdXJyZW50TnVtYmVyT2ZUYWdzKCk7XG4gICAgICB0aGlzLmlucHV0RWxlbWVudC5uYXRpdmVFbGVtZW50LnZhbHVlID0gJyc7XG4gICAgfVxuXG4gICAgdGhpcy52YWx1ZSA9IHRoaXMudmFsdWU7XG4gICAgdGhpcy5mb2N1cygpO1xuICB9XG5cbiAgYWRkVGFnRXZlbnQoZXZlbnQ6IEtleWJvYXJkRXZlbnQpIHtcbiAgICBjb25zdCBpbnB1dCA9IGV2ZW50LnRhcmdldCBhcyBIVE1MSW5wdXRFbGVtZW50O1xuXG4gICAgdGhpcy50YWdFcnJvciA9IG51bGw7XG4gICAgdGhpcy52YWx1ZSA9IHRoaXMudmFsdWU7XG5cbiAgICB0aGlzLnRleHRDaGFuZ2UuZW1pdChpbnB1dC52YWx1ZSk7XG4gICAgaWYgKFxuICAgICAgZXZlbnQua2V5Q29kZSA9PT0gS2V5Q29kZXMuQmFja3NwYWNlICYmXG4gICAgICB0aGlzLnByZXZUYWdJbnB1dC5sZW5ndGggPT09IDBcbiAgICApIHtcbiAgICAgIHRoaXMuX3ZhbHVlLnBvcCgpO1xuICAgICAgdGhpcy5zZXRDdXJyZW50TnVtYmVyT2ZUYWdzKCk7XG4gICAgfSBlbHNlIGlmIChcbiAgICAgIGV2ZW50LmtleUNvZGUgPT09IEtleUNvZGVzLkVudGVyIHx8XG4gICAgICBldmVudC5rZXlDb2RlID09PSBLZXlDb2Rlcy5Db21tYSB8fFxuICAgICAgZXZlbnQua2V5Q29kZSA9PT0gS2V5Q29kZXMuVGFiXG4gICAgKSB7XG4gICAgICB0aGlzLmFkZFRhZyhpbnB1dC52YWx1ZSk7XG4gICAgfVxuXG4gICAgdGhpcy5wcmV2VGFnSW5wdXQgPSBpbnB1dC52YWx1ZTtcbiAgfVxuXG4gIHByZXZlbnREZWZhdWx0VGFiQmVoYXZpb3IoZXZlbnQ6IEtleWJvYXJkRXZlbnQpIHtcbiAgICBpZiAoZXZlbnQua2V5Q29kZSA9PT0gS2V5Q29kZXMuVGFiICYmIHRoaXMucHJldlRhZ0lucHV0Lmxlbmd0aCA+IDApIHtcbiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgfVxuICB9XG5cbiAgYWRkVGFnQ2xpY2soZXZlbnQ6IE1vdXNlRXZlbnQsIHZhbHVlOiBzdHJpbmcpIHtcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIGlmICh2YWx1ZS5sZW5ndGggPiAwKSB7XG4gICAgICB0aGlzLmFkZFRhZyh2YWx1ZSk7XG4gICAgfVxuICB9XG5cbiAgYWRkU3VnZ2VzdGVkVGFnKHRhZzogc3RyaW5nKSB7XG4gICAgdGhpcy5hZGRUYWcodGFnKTtcbiAgfVxuXG4gIHJlbW92ZVRhZyh0YWc6IHN0cmluZywgZXZlbnQ6IGFueSkge1xuICAgIGlmIChldmVudC5rZXlDb2RlICE9PSBLZXlDb2Rlcy5FbnRlcikge1xuICAgICAgdGhpcy52YWx1ZSA9IHRoaXMuX3ZhbHVlLmZpbHRlcigodCkgPT4gdCAhPT0gdGFnKTtcbiAgICAgIHRoaXMuc2V0Q3VycmVudE51bWJlck9mVGFncygpO1xuICAgIH1cbiAgfVxuXG4gIGZvY3VzKCkge1xuICAgIHRoaXMuaW5wdXRFbGVtZW50Py5uYXRpdmVFbGVtZW50LmZvY3VzKCk7XG4gIH1cblxuICBzZXRDdXJyZW50TnVtYmVyT2ZUYWdzKCkge1xuICAgIHRoaXMuY3VycmVudE51bWJlck9mVGFncyA9IHRoaXMudmFsdWUubGVuZ3RoXG4gICAgICA/IHRoaXMudmFsdWUudG9TdHJpbmcoKS5zcGxpdCgnLCcpLmxlbmd0aFxuICAgICAgOiAwO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBmb3JtYXR0ZXIodGFnOiBzdHJpbmcpOiBzdHJpbmcge1xuICByZXR1cm4gdGFnXG4gICAgLnRyaW0oKVxuICAgIC5yZXBsYWNlKC8oXFxzfC0pKy9nLCAnLScpXG4gICAgLnJlcGxhY2UoL1xcLC9nLCAnJylcbiAgICAudG9Mb3dlckNhc2UoKTtcbn1cbiIsIjxkaXYgKGNsaWNrKT1cImZvY3VzKClcIiBjbGFzcz1cIm5neC1pbnB1dC10YWdcIj5cbiAgPGRpdiAqbmdGb3I9XCJsZXQgdGFnIG9mIHZhbHVlXCIgY2xhc3M9XCJuZ3gtaW5wdXQtdGFnX190YWdcIj5cbiAgICB7e3RhZ319XG4gICAgPGJ1dHRvbiB0eXBlPVwiYnV0dG9uXCIgKGNsaWNrKT1cInJlbW92ZVRhZyh0YWcsICRldmVudClcIj5cbiAgICAgICYjMTAwMDY7XG4gICAgPC9idXR0b24+XG4gIDwvZGl2PlxuICA8aW5wdXQgdHlwZT1cInRleHRcIiAjaW5wdXRFbGVtZW50IGFyaWEtbGFiZWw9XCJUYWdzXCIgW3N0eWxlLndpZHRoXT1cImlucHV0RWxlbWVudC52YWx1ZS5sZW5ndGggKiAxMCArIDEwICsgJ3B4J1wiIChrZXl1cCk9XCJhZGRUYWdFdmVudCgkZXZlbnQpXCIgKGtleWRvd24pPVwicHJldmVudERlZmF1bHRUYWJCZWhhdmlvcigkZXZlbnQpXCJcbiAgICBjbGFzcz1cIm5neC1pbnB1dC10YWdfX2lucHV0XCIgLz5cbiAgPGJ1dHRvbiB0eXBlPVwiYnV0dG9uXCIgYXJpYS1sYWJlbD1cIkFkZCBUYWdcIiB0aXRsZT1cIkFkZCBUYWdcIiAoY2xpY2spPVwiYWRkVGFnQ2xpY2soJGV2ZW50LCBpbnB1dEVsZW1lbnQudmFsdWUpXCIgY2xhc3M9XCJuZ3gtaW5wdXQtdGFnX19idG5cIj5cbiAgICArXG4gIDwvYnV0dG9uPlxuPC9kaXY+XG5cbjxkaXYgKm5nSWY9XCJpbnB1dEVsZW1lbnQudmFsdWUubGVuZ3RoICYmIHRhZ1N1Z2dlc3Rpb25zICYmIHRhZ1N1Z2dlc3Rpb25zLmxlbmd0aFwiIGNsYXNzPVwibmd4LWlucHV0LXRhZy1zdWdnZXN0aW9uc1wiPlxuICA8YnV0dG9uIHR5cGU9XCJidXR0b25cIiAoY2xpY2spPVwiYWRkU3VnZ2VzdGVkVGFnKHRhZylcIiAqbmdGb3I9XCJsZXQgdGFnIG9mIHRhZ1N1Z2dlc3Rpb25zXCIgY2xhc3M9XCJuZ3gtaW5wdXQtdGFnLXN1Z2dlc3Rpb25zX190YWdcIj57e3RhZ319PC9idXR0b24+XG48L2Rpdj4iXX0=